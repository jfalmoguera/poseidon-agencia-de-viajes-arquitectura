import { __rest } from "tslib";
import { isPlatformServer } from '@angular/common';
import { Inject, Injectable, Optional, PLATFORM_ID } from '@angular/core';
import { isComponent, isTemplateRef, ViewService } from '@ngneat/overview';
import { tap } from 'rxjs/operators';
import { HotToastContainerComponent } from './components/hot-toast-container/hot-toast-container.component';
import { HOT_TOAST_DEFAULT_TIMEOUTS } from './constants';
import { HotToastRef } from './hot-toast-ref';
import { resolveValueOrFunction, ToastConfig, ToastPersistConfig, } from './hot-toast.model';
import * as i0 from "@angular/core";
import * as i1 from "@ngneat/overview";
import * as i2 from "./hot-toast.model";
export class HotToastService {
    constructor(_viewService, platformId, config) {
        this._viewService = _viewService;
        this.platformId = platformId;
        this._isInitialized = false;
        this._defaultConfig = new ToastConfig();
        this._defaultPersistConfig = new ToastPersistConfig();
        if (config) {
            this._defaultConfig = Object.assign(Object.assign({}, this._defaultConfig), config);
        }
    }
    get defaultConfig() {
        return this._defaultConfig;
    }
    set defaultConfig(config) {
        this._defaultConfig = Object.assign(Object.assign({}, this._defaultConfig), config);
        if (this._componentRef) {
            this._componentRef.setInput('defaultConfig', this._defaultConfig);
        }
    }
    /**
     * Opens up an hot-toast without any pre-configurations
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    show(message, options) {
        const toast = this.createToast(message || this._defaultConfig.blank.content, 'blank', Object.assign(Object.assign({}, this._defaultConfig), options));
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for error state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    error(message, options) {
        var _a;
        const toast = this.createToast(message || this._defaultConfig.error.content, 'error', Object.assign(Object.assign(Object.assign({}, this._defaultConfig), (_a = this._defaultConfig) === null || _a === void 0 ? void 0 : _a.error), options));
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for success state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    success(message, options) {
        var _a;
        const toast = this.createToast(message || this._defaultConfig.success.content, 'success', Object.assign(Object.assign(Object.assign({}, this._defaultConfig), (_a = this._defaultConfig) === null || _a === void 0 ? void 0 : _a.success), options));
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for loading state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    loading(message, options) {
        var _a;
        const toast = this.createToast(message || this._defaultConfig.loading.content, 'loading', Object.assign(Object.assign(Object.assign({}, this._defaultConfig), (_a = this._defaultConfig) === null || _a === void 0 ? void 0 : _a.loading), options));
        return toast;
    }
    /**
     * Opens up an hot-toast with pre-configurations for warning state
     *
     * @param message The message to show in the hot-toast.
     * @param [options] Additional configuration options for the hot-toast.
     * @returns
     * @memberof HotToastService
     */
    warning(message, options) {
        var _a;
        const toast = this.createToast(message || this._defaultConfig.warning.content, 'warning', Object.assign(Object.assign(Object.assign({}, this._defaultConfig), (_a = this._defaultConfig) === null || _a === void 0 ? void 0 : _a.warning), options));
        return toast;
    }
    /**
     *
     *  Opens up an hot-toast with pre-configurations for loading initially and then changes state based on messages
     *
     * @template T Type of observable
     * @param messages Messages for each state i.e. loading, success and error
     * @returns
     * @memberof HotToastService
     */
    observe(messages) {
        return (source) => {
            var _a, _b;
            let toastRef;
            let start = 0;
            const loadingContent = messages.loading || ((_a = this._defaultConfig.loading) === null || _a === void 0 ? void 0 : _a.content);
            const errorContent = messages.error || ((_b = this._defaultConfig.error) === null || _b === void 0 ? void 0 : _b.content);
            if (loadingContent) {
                toastRef = this.createLoadingToast(loadingContent);
                start = Date.now();
            }
            return source.pipe(tap(Object.assign({ next: (val) => {
                    toastRef = this.createOrUpdateToast(messages, val, toastRef, 'success', start === 0 ? start : Date.now() - start);
                } }, (errorContent && {
                error: (e) => {
                    toastRef = this.createOrUpdateToast(messages, e, toastRef, 'error', start === 0 ? start : Date.now() - start);
                },
            }))));
        };
    }
    /**
     * Closes the hot-toast
     *
     * @param [id] - ID of the toast
     * @since 3.0.1 - If ID is not provided, all toasts will be closed
     */
    close(id) {
        if (this._componentRef) {
            this._componentRef.ref.instance.closeToast(id);
        }
    }
    /**
     * Used for internal purpose only.
     * Creates a container component and attaches it to document.body.
     */
    init() {
        if (isPlatformServer(this.platformId)) {
            return;
        }
        this._componentRef = this._viewService
            .createComponent(HotToastContainerComponent)
            .setInput('defaultConfig', this._defaultConfig)
            .appendTo(document.body);
    }
    createOrUpdateToast(messages, val, toastRef, type, diff) {
        let content = null;
        let options = {};
        ({ content, options } = this.getContentAndOptions(type, messages[type] || (this._defaultConfig[type] ? this._defaultConfig[type].content : '')));
        content = resolveValueOrFunction(content, val);
        if (toastRef) {
            toastRef.updateMessage(content);
            const updatedOptions = Object.assign(Object.assign({ type, duration: diff + HOT_TOAST_DEFAULT_TIMEOUTS[type] }, options), (options.duration && { duration: diff + options.duration }));
            toastRef.updateToast(updatedOptions);
        }
        else {
            this.createToast(content, type, options);
        }
        return toastRef;
    }
    createToast(message, type, options, observableMessages) {
        var _a, _b, _c, _d, _e, _f;
        if (!this._isInitialized) {
            this._isInitialized = true;
            this.init();
        }
        const now = Date.now();
        const id = (_a = options === null || options === void 0 ? void 0 : options.id) !== null && _a !== void 0 ? _a : now.toString();
        if (!this.isDuplicate(id) &&
            (!((_b = options.persist) === null || _b === void 0 ? void 0 : _b.enabled) || (((_c = options.persist) === null || _c === void 0 ? void 0 : _c.enabled) && this.handleStorageValue(id, options)))) {
            const toast = Object.assign({ ariaLive: (_d = options === null || options === void 0 ? void 0 : options.ariaLive) !== null && _d !== void 0 ? _d : 'polite', createdAt: now, duration: (_e = options === null || options === void 0 ? void 0 : options.duration) !== null && _e !== void 0 ? _e : HOT_TOAST_DEFAULT_TIMEOUTS[type], id,
                message, role: (_f = options === null || options === void 0 ? void 0 : options.role) !== null && _f !== void 0 ? _f : 'status', type, visible: true, observableMessages: observableMessages !== null && observableMessages !== void 0 ? observableMessages : undefined }, options);
            return new HotToastRef(toast).appendTo(this._componentRef.ref.instance);
        }
    }
    /**
     * Checks whether any toast with same id is present.
     *
     * @private
     * @param id - Toast ID
     */
    isDuplicate(id) {
        return this._componentRef.ref.instance.hasToast(id);
    }
    /**
     * Creates an entry in local or session storage with count ${defaultConfig.persist.count}, if not present.
     * If present in storage, reduces the count
     * and returns the count.
     * Count can not be less than 0.
     */
    handleStorageValue(id, options) {
        let count = 1;
        const persist = Object.assign(Object.assign({}, this._defaultPersistConfig), options.persist);
        const storage = persist.storage === 'local' ? localStorage : sessionStorage;
        const key = persist.key.replace(/\${id}/g, id);
        let item = storage.getItem(key);
        if (item) {
            item = parseInt(item, 10);
            if (item > 0) {
                count = item - 1;
            }
            else {
                count = item;
            }
        }
        else {
            count = persist.count;
        }
        storage.setItem(key, count.toString());
        return count;
    }
    getContentAndOptions(toastType, message) {
        var _a;
        let content;
        let options = Object.assign(Object.assign({}, this._defaultConfig), this._defaultConfig[toastType]);
        // typeof message === 'object' won't work, cz TemplateRef's type is object
        if (typeof message === 'string' || isTemplateRef(message) || isComponent(message)) {
            content = message;
        }
        else {
            let restOptions;
            (_a = message, { content } = _a, restOptions = __rest(_a, ["content"]));
            options = Object.assign(Object.assign({}, options), restOptions);
        }
        return { content, options };
    }
    createLoadingToast(messages) {
        let content = null;
        let options = {};
        ({ content, options } = this.getContentAndOptions('loading', messages));
        return this.loading(content, options);
    }
}
HotToastService.ɵprov = i0.ɵɵdefineInjectable({ factory: function HotToastService_Factory() { return new HotToastService(i0.ɵɵinject(i1.ViewService), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i2.ToastConfig, 8)); }, token: HotToastService, providedIn: "root" });
HotToastService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
HotToastService.ctorParameters = () => [
    { type: ViewService },
    { type: String, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: ToastConfig, decorators: [{ type: Optional }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2hvdC10b2FzdC9zcmMvIiwic291cmNlcyI6WyJsaWIvaG90LXRvYXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUUsT0FBTyxFQUFvQixXQUFXLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTdGLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnRUFBZ0UsQ0FBQztBQUM1RyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlDLE9BQU8sRUFPTCxzQkFBc0IsRUFFdEIsV0FBVyxFQUVYLGtCQUFrQixHQUluQixNQUFNLG1CQUFtQixDQUFDOzs7O0FBRzNCLE1BQU0sT0FBTyxlQUFlO0lBbUIxQixZQUNVLFlBQXlCLEVBQ0osVUFBa0IsRUFDbkMsTUFBbUI7UUFGdkIsaUJBQVksR0FBWixZQUFZLENBQWE7UUFDSixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBcEJ6QyxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUd2QixtQkFBYyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFhbkMsMEJBQXFCLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDO1FBT3ZELElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBSSxDQUFDLGNBQWMsbUNBQ2QsSUFBSSxDQUFDLGNBQWMsR0FDbkIsTUFBTSxDQUNWLENBQUM7U0FDSDtJQUNI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IjpbImltcG9ydCB7IGlzUGxhdGZvcm1TZXJ2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCwgUExBVEZPUk1fSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbXBSZWYsIENvbnRlbnQsIGlzQ29tcG9uZW50LCBpc1RlbXBsYXRlUmVmLCBWaWV3U2VydmljZSB9IGZyb20gJ0BuZ25lYXQvb3ZlcnZpZXcnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBIb3RUb2FzdENvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4vY29tcG9uZW50cy9ob3QtdG9hc3QtY29udGFpbmVyL2hvdC10b2FzdC1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7IEhPVF9UT0FTVF9ERUZBVUxUX1RJTUVPVVRTIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgSG90VG9hc3RSZWYgfSBmcm9tICcuL2hvdC10b2FzdC1yZWYnO1xuaW1wb3J0IHtcbiAgQ3JlYXRlSG90VG9hc3RSZWYsXG4gIERlZmF1bHRUb2FzdE9wdGlvbnMsXG4gIEhvdFRvYXN0U2VydmljZU1ldGhvZHMsXG4gIE9ic2VydmFibGVMb2FkaW5nLFxuICBPYnNlcnZhYmxlTWVzc2FnZXMsXG4gIE9ic2VydmFibGVTdWNjZXNzT3JFcnJvcixcbiAgcmVzb2x2ZVZhbHVlT3JGdW5jdGlvbixcbiAgVG9hc3QsXG4gIFRvYXN0Q29uZmlnLFxuICBUb2FzdE9wdGlvbnMsXG4gIFRvYXN0UGVyc2lzdENvbmZpZyxcbiAgVG9hc3RUeXBlLFxuICBVcGRhdGVUb2FzdE9wdGlvbnMsXG4gIFZhbHVlT3JGdW5jdGlvbixcbn0gZnJvbSAnLi9ob3QtdG9hc3QubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIEhvdFRvYXN0U2VydmljZSBpbXBsZW1lbnRzIEhvdFRvYXN0U2VydmljZU1ldGhvZHMge1xuICBwcml2YXRlIF9pc0luaXRpYWxpemVkID0gZmFsc2U7XG4gIHByaXZhdGUgX2NvbXBvbmVudFJlZjogQ29tcFJlZjxIb3RUb2FzdENvbnRhaW5lckNvbXBvbmVudD47XG5cbiAgcHJpdmF0ZSBfZGVmYXVsdENvbmZpZyA9IG5ldyBUb2FzdENvbmZpZygpO1xuICBnZXQgZGVmYXVsdENvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5fZGVmYXVsdENvbmZpZztcbiAgfVxuICBzZXQgZGVmYXVsdENvbmZpZyhjb25maWc6IFRvYXN0Q29uZmlnKSB7XG4gICAgdGhpcy5fZGVmYXVsdENvbmZpZyA9IHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi5jb25maWcsXG4gICAgfTtcbiAgICBpZiAodGhpcy5fY29tcG9uZW50UmVmKSB7XG4gICAgICB0aGlzLl9jb21wb25lbnRSZWYuc2V0SW5wdXQoJ2RlZmF1bHRDb25maWcnLCB0aGlzLl9kZWZhdWx0Q29uZmlnKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBfZGVmYXVsdFBlcnNpc3RDb25maWcgPSBuZXcgVG9hc3RQZXJzaXN0Q29uZmlnKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfdmlld1NlcnZpY2U6IFZpZXdTZXJ2aWNlLFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpIGNvbmZpZzogVG9hc3RDb25maWdcbiAgKSB7XG4gICAgaWYgKGNvbmZpZykge1xuICAgICAgdGhpcy5fZGVmYXVsdENvbmZpZyA9IHtcbiAgICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgICAgLi4uY29uZmlnLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGhvdXQgYW55IHByZS1jb25maWd1cmF0aW9uc1xuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIHNob3c8RGF0YVR5cGU+KG1lc3NhZ2U/OiBDb250ZW50LCBvcHRpb25zPzogVG9hc3RPcHRpb25zPERhdGFUeXBlPik6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj4ge1xuICAgIGNvbnN0IHRvYXN0ID0gdGhpcy5jcmVhdGVUb2FzdDxEYXRhVHlwZT4obWVzc2FnZSB8fCB0aGlzLl9kZWZhdWx0Q29uZmlnLmJsYW5rLmNvbnRlbnQsICdibGFuaycsIHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIHVwIGFuIGhvdC10b2FzdCB3aXRoIHByZS1jb25maWd1cmF0aW9ucyBmb3IgZXJyb3Igc3RhdGVcbiAgICpcbiAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2hvdyBpbiB0aGUgaG90LXRvYXN0LlxuICAgKiBAcGFyYW0gW29wdGlvbnNdIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgaG90LXRvYXN0LlxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICBlcnJvcjxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcuZXJyb3IuY29udGVudCwgJ2Vycm9yJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWc/LmVycm9yLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB1cCBhbiBob3QtdG9hc3Qgd2l0aCBwcmUtY29uZmlndXJhdGlvbnMgZm9yIHN1Y2Nlc3Mgc3RhdGVcbiAgICpcbiAgICogQHBhcmFtIG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2hvdyBpbiB0aGUgaG90LXRvYXN0LlxuICAgKiBAcGFyYW0gW29wdGlvbnNdIEFkZGl0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgaG90LXRvYXN0LlxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICBzdWNjZXNzPERhdGFUeXBlPihtZXNzYWdlPzogQ29udGVudCwgb3B0aW9ucz86IFRvYXN0T3B0aW9uczxEYXRhVHlwZT4pOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBjb25zdCB0b2FzdCA9IHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGU+KG1lc3NhZ2UgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy5zdWNjZXNzLmNvbnRlbnQsICdzdWNjZXNzJywge1xuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZyxcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWc/LnN1Y2Nlc3MsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRvYXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIHVwIGFuIGhvdC10b2FzdCB3aXRoIHByZS1jb25maWd1cmF0aW9ucyBmb3IgbG9hZGluZyBzdGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzaG93IGluIHRoZSBob3QtdG9hc3QuXG4gICAqIEBwYXJhbSBbb3B0aW9uc10gQWRkaXRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBob3QtdG9hc3QuXG4gICAqIEByZXR1cm5zXG4gICAqIEBtZW1iZXJvZiBIb3RUb2FzdFNlcnZpY2VcbiAgICovXG4gIGxvYWRpbmc8RGF0YVR5cGU+KG1lc3NhZ2U/OiBDb250ZW50LCBvcHRpb25zPzogVG9hc3RPcHRpb25zPERhdGFUeXBlPik6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj4ge1xuICAgIGNvbnN0IHRvYXN0ID0gdGhpcy5jcmVhdGVUb2FzdDxEYXRhVHlwZT4obWVzc2FnZSB8fCB0aGlzLl9kZWZhdWx0Q29uZmlnLmxvYWRpbmcuY29udGVudCwgJ2xvYWRpbmcnLCB7XG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5fZGVmYXVsdENvbmZpZz8ubG9hZGluZyxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdG9hc3Q7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGggcHJlLWNvbmZpZ3VyYXRpb25zIGZvciB3YXJuaW5nIHN0YXRlXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIHNob3cgaW4gdGhlIGhvdC10b2FzdC5cbiAgICogQHBhcmFtIFtvcHRpb25zXSBBZGRpdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGhvdC10b2FzdC5cbiAgICogQHJldHVybnNcbiAgICogQG1lbWJlcm9mIEhvdFRvYXN0U2VydmljZVxuICAgKi9cbiAgd2FybmluZzxEYXRhVHlwZT4obWVzc2FnZT86IENvbnRlbnQsIG9wdGlvbnM/OiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+KTogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGUgfCB1bmtub3duPiB7XG4gICAgY29uc3QgdG9hc3QgPSB0aGlzLmNyZWF0ZVRvYXN0PERhdGFUeXBlPihtZXNzYWdlIHx8IHRoaXMuX2RlZmF1bHRDb25maWcud2FybmluZy5jb250ZW50LCAnd2FybmluZycsIHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnPy53YXJuaW5nLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcblxuICAgIHJldHVybiB0b2FzdDtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiAgT3BlbnMgdXAgYW4gaG90LXRvYXN0IHdpdGggcHJlLWNvbmZpZ3VyYXRpb25zIGZvciBsb2FkaW5nIGluaXRpYWxseSBhbmQgdGhlbiBjaGFuZ2VzIHN0YXRlIGJhc2VkIG9uIG1lc3NhZ2VzXG4gICAqXG4gICAqIEB0ZW1wbGF0ZSBUIFR5cGUgb2Ygb2JzZXJ2YWJsZVxuICAgKiBAcGFyYW0gbWVzc2FnZXMgTWVzc2FnZXMgZm9yIGVhY2ggc3RhdGUgaS5lLiBsb2FkaW5nLCBzdWNjZXNzIGFuZCBlcnJvclxuICAgKiBAcmV0dXJuc1xuICAgKiBAbWVtYmVyb2YgSG90VG9hc3RTZXJ2aWNlXG4gICAqL1xuICBvYnNlcnZlPFQsIERhdGFUeXBlPihtZXNzYWdlczogT2JzZXJ2YWJsZU1lc3NhZ2VzPFQsIERhdGFUeXBlPik6IChzb3VyY2U6IE9ic2VydmFibGU8VD4pID0+IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiAoc291cmNlKSA9PiB7XG4gICAgICBsZXQgdG9hc3RSZWY6IENyZWF0ZUhvdFRvYXN0UmVmPERhdGFUeXBlIHwgdW5rbm93bj47XG4gICAgICBsZXQgc3RhcnQgPSAwO1xuXG4gICAgICBjb25zdCBsb2FkaW5nQ29udGVudCA9IG1lc3NhZ2VzLmxvYWRpbmcgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy5sb2FkaW5nPy5jb250ZW50O1xuICAgICAgY29uc3QgZXJyb3JDb250ZW50ID0gbWVzc2FnZXMuZXJyb3IgfHwgdGhpcy5fZGVmYXVsdENvbmZpZy5lcnJvcj8uY29udGVudDtcblxuICAgICAgaWYgKGxvYWRpbmdDb250ZW50KSB7XG4gICAgICAgIHRvYXN0UmVmID0gdGhpcy5jcmVhdGVMb2FkaW5nVG9hc3Q8VCwgRGF0YVR5cGU+KGxvYWRpbmdDb250ZW50KTtcbiAgICAgICAgc3RhcnQgPSBEYXRlLm5vdygpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gc291cmNlLnBpcGUoXG4gICAgICAgIHRhcCh7XG4gICAgICAgICAgbmV4dDogKHZhbCkgPT4ge1xuICAgICAgICAgICAgdG9hc3RSZWYgPSB0aGlzLmNyZWF0ZU9yVXBkYXRlVG9hc3Q8VCwgRGF0YVR5cGUgfCB1bmtub3duPihcbiAgICAgICAgICAgICAgbWVzc2FnZXMsXG4gICAgICAgICAgICAgIHZhbCxcbiAgICAgICAgICAgICAgdG9hc3RSZWYsXG4gICAgICAgICAgICAgICdzdWNjZXNzJyxcbiAgICAgICAgICAgICAgc3RhcnQgPT09IDAgPyBzdGFydCA6IERhdGUubm93KCkgLSBzdGFydFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIC4uLihlcnJvckNvbnRlbnQgJiYge1xuICAgICAgICAgICAgZXJyb3I6IChlKSA9PiB7XG4gICAgICAgICAgICAgIHRvYXN0UmVmID0gdGhpcy5jcmVhdGVPclVwZGF0ZVRvYXN0PFQsIERhdGFUeXBlIHwgdW5rbm93bj4oXG4gICAgICAgICAgICAgICAgbWVzc2FnZXMsXG4gICAgICAgICAgICAgICAgZSxcbiAgICAgICAgICAgICAgICB0b2FzdFJlZixcbiAgICAgICAgICAgICAgICAnZXJyb3InLFxuICAgICAgICAgICAgICAgIHN0YXJ0ID09PSAwID8gc3RhcnQgOiBEYXRlLm5vdygpIC0gc3RhcnRcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBob3QtdG9hc3RcbiAgICpcbiAgICogQHBhcmFtIFtpZF0gLSBJRCBvZiB0aGUgdG9hc3RcbiAgICogQHNpbmNlIDMuMC4xIC0gSWYgSUQgaXMgbm90IHByb3ZpZGVkLCBhbGwgdG9hc3RzIHdpbGwgYmUgY2xvc2VkXG4gICAqL1xuICBjbG9zZShpZD86IHN0cmluZykge1xuICAgIGlmICh0aGlzLl9jb21wb25lbnRSZWYpIHtcbiAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5yZWYuaW5zdGFuY2UuY2xvc2VUb2FzdChpZCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVzZWQgZm9yIGludGVybmFsIHB1cnBvc2Ugb25seS5cbiAgICogQ3JlYXRlcyBhIGNvbnRhaW5lciBjb21wb25lbnQgYW5kIGF0dGFjaGVzIGl0IHRvIGRvY3VtZW50LmJvZHkuXG4gICAqL1xuICBwcml2YXRlIGluaXQoKSB7XG4gICAgaWYgKGlzUGxhdGZvcm1TZXJ2ZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jb21wb25lbnRSZWYgPSB0aGlzLl92aWV3U2VydmljZVxuICAgICAgLmNyZWF0ZUNvbXBvbmVudChIb3RUb2FzdENvbnRhaW5lckNvbXBvbmVudClcbiAgICAgIC5zZXRJbnB1dCgnZGVmYXVsdENvbmZpZycsIHRoaXMuX2RlZmF1bHRDb25maWcpXG4gICAgICAuYXBwZW5kVG8oZG9jdW1lbnQuYm9keSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZU9yVXBkYXRlVG9hc3Q8VCwgRGF0YVR5cGU+KFxuICAgIG1lc3NhZ2VzOiBPYnNlcnZhYmxlTWVzc2FnZXM8VCwgRGF0YVR5cGU+LFxuICAgIHZhbDogdW5rbm93bixcbiAgICB0b2FzdFJlZjogQ3JlYXRlSG90VG9hc3RSZWY8RGF0YVR5cGU+LFxuICAgIHR5cGU6IFRvYXN0VHlwZSxcbiAgICBkaWZmOiBudW1iZXJcbiAgKSB7XG4gICAgbGV0IGNvbnRlbnQ6IENvbnRlbnQgfCBWYWx1ZU9yRnVuY3Rpb248Q29udGVudCwgVD4gPSBudWxsO1xuICAgIGxldCBvcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGUgfCB1bmtub3duPiA9IHt9O1xuICAgICh7IGNvbnRlbnQsIG9wdGlvbnMgfSA9IHRoaXMuZ2V0Q29udGVudEFuZE9wdGlvbnM8YW55LCBEYXRhVHlwZT4oXG4gICAgICB0eXBlLFxuICAgICAgbWVzc2FnZXNbdHlwZV0gfHwgKHRoaXMuX2RlZmF1bHRDb25maWdbdHlwZV0gPyB0aGlzLl9kZWZhdWx0Q29uZmlnW3R5cGVdLmNvbnRlbnQgOiAnJylcbiAgICApKTtcbiAgICBjb250ZW50ID0gcmVzb2x2ZVZhbHVlT3JGdW5jdGlvbihjb250ZW50LCB2YWwpO1xuICAgIGlmICh0b2FzdFJlZikge1xuICAgICAgdG9hc3RSZWYudXBkYXRlTWVzc2FnZShjb250ZW50KTtcbiAgICAgIGNvbnN0IHVwZGF0ZWRPcHRpb25zOiBVcGRhdGVUb2FzdE9wdGlvbnM8RGF0YVR5cGU+ID0ge1xuICAgICAgICB0eXBlLFxuICAgICAgICBkdXJhdGlvbjogZGlmZiArIEhPVF9UT0FTVF9ERUZBVUxUX1RJTUVPVVRTW3R5cGVdLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAuLi4ob3B0aW9ucy5kdXJhdGlvbiAmJiB7IGR1cmF0aW9uOiBkaWZmICsgb3B0aW9ucy5kdXJhdGlvbiB9KSxcbiAgICAgIH07XG4gICAgICB0b2FzdFJlZi51cGRhdGVUb2FzdCh1cGRhdGVkT3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlVG9hc3Q8RGF0YVR5cGUsIFQ+KGNvbnRlbnQsIHR5cGUsIG9wdGlvbnMpO1xuICAgIH1cbiAgICByZXR1cm4gdG9hc3RSZWY7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVRvYXN0PERhdGFUeXBlLCBUID0gdW5rbm93bj4oXG4gICAgbWVzc2FnZTogQ29udGVudCxcbiAgICB0eXBlOiBUb2FzdFR5cGUsXG4gICAgb3B0aW9ucz86IERlZmF1bHRUb2FzdE9wdGlvbnMsXG4gICAgb2JzZXJ2YWJsZU1lc3NhZ2VzPzogT2JzZXJ2YWJsZU1lc3NhZ2VzPFQsIERhdGFUeXBlPlxuICApOiBDcmVhdGVIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+IHtcbiAgICBpZiAoIXRoaXMuX2lzSW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5pbml0KCk7XG4gICAgfVxuXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCBpZCA9IG9wdGlvbnM/LmlkID8/IG5vdy50b1N0cmluZygpO1xuXG4gICAgaWYgKFxuICAgICAgIXRoaXMuaXNEdXBsaWNhdGUoaWQpICYmXG4gICAgICAoIW9wdGlvbnMucGVyc2lzdD8uZW5hYmxlZCB8fCAob3B0aW9ucy5wZXJzaXN0Py5lbmFibGVkICYmIHRoaXMuaGFuZGxlU3RvcmFnZVZhbHVlKGlkLCBvcHRpb25zKSkpXG4gICAgKSB7XG4gICAgICBjb25zdCB0b2FzdDogVG9hc3Q8RGF0YVR5cGUgfCB1bmtub3duPiA9IHtcbiAgICAgICAgYXJpYUxpdmU6IG9wdGlvbnM/LmFyaWFMaXZlID8/ICdwb2xpdGUnLFxuICAgICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgICAgZHVyYXRpb246IG9wdGlvbnM/LmR1cmF0aW9uID8/IEhPVF9UT0FTVF9ERUZBVUxUX1RJTUVPVVRTW3R5cGVdLFxuICAgICAgICBpZCxcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgcm9sZTogb3B0aW9ucz8ucm9sZSA/PyAnc3RhdHVzJyxcbiAgICAgICAgdHlwZSxcbiAgICAgICAgdmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgb2JzZXJ2YWJsZU1lc3NhZ2VzOiBvYnNlcnZhYmxlTWVzc2FnZXMgPz8gdW5kZWZpbmVkLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIG5ldyBIb3RUb2FzdFJlZjxEYXRhVHlwZSB8IHVua25vd24+KHRvYXN0KS5hcHBlbmRUbyh0aGlzLl9jb21wb25lbnRSZWYucmVmLmluc3RhbmNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIHdoZXRoZXIgYW55IHRvYXN0IHdpdGggc2FtZSBpZCBpcyBwcmVzZW50LlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAcGFyYW0gaWQgLSBUb2FzdCBJRFxuICAgKi9cbiAgcHJpdmF0ZSBpc0R1cGxpY2F0ZShpZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbXBvbmVudFJlZi5yZWYuaW5zdGFuY2UuaGFzVG9hc3QoaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gZW50cnkgaW4gbG9jYWwgb3Igc2Vzc2lvbiBzdG9yYWdlIHdpdGggY291bnQgJHtkZWZhdWx0Q29uZmlnLnBlcnNpc3QuY291bnR9LCBpZiBub3QgcHJlc2VudC5cbiAgICogSWYgcHJlc2VudCBpbiBzdG9yYWdlLCByZWR1Y2VzIHRoZSBjb3VudFxuICAgKiBhbmQgcmV0dXJucyB0aGUgY291bnQuXG4gICAqIENvdW50IGNhbiBub3QgYmUgbGVzcyB0aGFuIDAuXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZVN0b3JhZ2VWYWx1ZShpZDogc3RyaW5nLCBvcHRpb25zOiBEZWZhdWx0VG9hc3RPcHRpb25zKTogbnVtYmVyIHtcbiAgICBsZXQgY291bnQgPSAxO1xuICAgIGNvbnN0IHBlcnNpc3QgPSB7IC4uLnRoaXMuX2RlZmF1bHRQZXJzaXN0Q29uZmlnLCAuLi5vcHRpb25zLnBlcnNpc3QgfTtcbiAgICBjb25zdCBzdG9yYWdlOiBTdG9yYWdlID0gcGVyc2lzdC5zdG9yYWdlID09PSAnbG9jYWwnID8gbG9jYWxTdG9yYWdlIDogc2Vzc2lvblN0b3JhZ2U7XG4gICAgY29uc3Qga2V5ID0gcGVyc2lzdC5rZXkucmVwbGFjZSgvXFwke2lkfS9nLCBpZCk7XG5cbiAgICBsZXQgaXRlbTogc3RyaW5nIHwgbnVtYmVyID0gc3RvcmFnZS5nZXRJdGVtKGtleSk7XG5cbiAgICBpZiAoaXRlbSkge1xuICAgICAgaXRlbSA9IHBhcnNlSW50KGl0ZW0sIDEwKTtcbiAgICAgIGlmIChpdGVtID4gMCkge1xuICAgICAgICBjb3VudCA9IGl0ZW0gLSAxO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY291bnQgPSBpdGVtO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb3VudCA9IHBlcnNpc3QuY291bnQ7XG4gICAgfVxuXG4gICAgc3RvcmFnZS5zZXRJdGVtKGtleSwgY291bnQudG9TdHJpbmcoKSk7XG5cbiAgICByZXR1cm4gY291bnQ7XG4gIH1cblxuICBwcml2YXRlIGdldENvbnRlbnRBbmRPcHRpb25zPFQsIERhdGFUeXBlPihcbiAgICB0b2FzdFR5cGU6IFRvYXN0VHlwZSxcbiAgICBtZXNzYWdlOiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+IHwgT2JzZXJ2YWJsZUxvYWRpbmc8RGF0YVR5cGU+IHwgT2JzZXJ2YWJsZVN1Y2Nlc3NPckVycm9yPFQsIERhdGFUeXBlPlxuICApOiB7IG9wdGlvbnM6IFRvYXN0T3B0aW9uczxEYXRhVHlwZSB8IHVua25vd24+OyBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+IH0ge1xuICAgIGxldCBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+O1xuICAgIGxldCBvcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGUgfCB1bmtub3duPiA9IHtcbiAgICAgIC4uLnRoaXMuX2RlZmF1bHRDb25maWcsXG4gICAgICAuLi50aGlzLl9kZWZhdWx0Q29uZmlnW3RvYXN0VHlwZV0sXG4gICAgfTtcblxuICAgIC8vIHR5cGVvZiBtZXNzYWdlID09PSAnb2JqZWN0JyB3b24ndCB3b3JrLCBjeiBUZW1wbGF0ZVJlZidzIHR5cGUgaXMgb2JqZWN0XG4gICAgaWYgKHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJyB8fCBpc1RlbXBsYXRlUmVmKG1lc3NhZ2UpIHx8IGlzQ29tcG9uZW50KG1lc3NhZ2UpKSB7XG4gICAgICBjb250ZW50ID0gbWVzc2FnZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHJlc3RPcHRpb25zOiBUb2FzdE9wdGlvbnM8RGF0YVR5cGU+O1xuICAgICAgKHsgY29udGVudCwgLi4ucmVzdE9wdGlvbnMgfSA9IG1lc3NhZ2UgYXMgT2JzZXJ2YWJsZUxvYWRpbmc8RGF0YVR5cGU+IHwgT2JzZXJ2YWJsZVN1Y2Nlc3NPckVycm9yPFQsIERhdGFUeXBlPik7XG4gICAgICBvcHRpb25zID0geyAuLi5vcHRpb25zLCAuLi5yZXN0T3B0aW9ucyB9O1xuICAgIH1cblxuICAgIHJldHVybiB7IGNvbnRlbnQsIG9wdGlvbnMgfTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTG9hZGluZ1RvYXN0PFQsIERhdGFUeXBlPihtZXNzYWdlczogQ29udGVudCB8IE9ic2VydmFibGVMb2FkaW5nPERhdGFUeXBlPikge1xuICAgIGxldCBjb250ZW50OiBDb250ZW50IHwgVmFsdWVPckZ1bmN0aW9uPENvbnRlbnQsIFQ+ID0gbnVsbDtcbiAgICBsZXQgb3B0aW9uczogVG9hc3RPcHRpb25zPERhdGFUeXBlIHwgdW5rbm93bj4gPSB7fTtcblxuICAgICh7IGNvbnRlbnQsIG9wdGlvbnMgfSA9IHRoaXMuZ2V0Q29udGVudEFuZE9wdGlvbnM8YW55LCBEYXRhVHlwZT4oJ2xvYWRpbmcnLCBtZXNzYWdlcykpO1xuXG4gICAgcmV0dXJuIHRoaXMubG9hZGluZyhjb250ZW50IGFzIENvbnRlbnQsIG9wdGlvbnMpO1xuICB9XG59XG4iXX0=